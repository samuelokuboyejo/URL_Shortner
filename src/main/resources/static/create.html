<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Short Link</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        header { background-color: #0078D7; color: white; padding: 15px 0; text-align: center; margin-bottom: 20px; }
        nav a { color: white; margin: 0 15px; text-decoration: none; font-weight: 500; }
        nav a:hover { text-decoration: underline; }
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; }
        .form-container { max-width: 600px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 30px; margin: 40px auto; }
        .card { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
        .card:hover { transform: scale(1.01); }
        .copy-btn { background-color: #0078D7; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .copy-btn:hover { background-color: #005fa3; }
    </style>
</head>

<body>

<header id="mainHeader">
    <h2>URL Shortener</h2>
    <nav>
        <a href="/dashboard.html">Dashboard</a>
        <a href="/create.html">Create Link</a>
        <a href="/public.html">Public Links</a>
        <a href="#" id="logoutLink">Logout</a>
    </nav>
</header>

<div class="form-container">
    <h3 class="text-center mb-4">Create a Short Link</h3>

    <form id="createLinkForm">
        <div class="mb-3">
            <label for="originalUrl" class="form-label">Original URL</label>
            <input type="url" id="originalUrl" class="form-control" placeholder="https://example.com" required>
        </div>

        <div class="mb-3">
            <label for="customCode" class="form-label">Custom Short Code (optional)</label>
            <input type="text" id="customCode" class="form-control" placeholder="my-custom-code">
        </div>

        <div class="mb-3">
            <label for="ttlDays" class="form-label">Expiration (TTL in Days)</label>
            <input type="number" id="ttlDays" class="form-control" value="7" min="1" max="365">
        </div>

        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="isPrivate">
            <label class="form-check-label" for="isPrivate">Make link private</label>
        </div>

        <button type="submit" class="btn btn-primary w-100">Generate Short Link</button>
    </form>

    <div id="successContainer" class="mt-4" style="display:none;"></div>
    <div id="errorMsg" class="text-danger text-center mt-3" style="display:none;"></div>
</div>

<script>
    const logoutLink = document.getElementById("logoutLink");
    if (logoutLink) {
      logoutLink.addEventListener("click", e => {
        e.preventDefault();
        localStorage.removeItem("accessToken");
        localStorage.removeItem("refreshToken");
        window.location.href = "/login.html";
      });
    }

    const token = localStorage.getItem("accessToken");
    if (!token) window.location.href = "/login.html";


    async function handleRedirect(shortCode) {
    const token = localStorage.getItem("accessToken");
    const redirectUrl = token
    ? `/url-shortner/${shortCode}?token=${token}`
    : `/url-shortner/${shortCode}`;

      try {
        window.location.href = redirectUrl;
      } catch (err) {
        console.error("Redirect error:", err);
        alert("Unexpected error occurred during redirect.");
      }
}


    const form = document.getElementById("createLinkForm");
    const successContainer = document.getElementById("successContainer");
    const errorMsg = document.getElementById("errorMsg");

    form.addEventListener("submit", async e => {
      e.preventDefault();

      const body = {
        originalUrl: document.getElementById("originalUrl").value,
        customShortCode: document.getElementById("customCode").value || null,
        ttlDays: parseInt(document.getElementById("ttlDays").value) || 7,
        isPrivate: document.getElementById("isPrivate").checked
      };

      try {
        const res = await fetch("/url-shortner", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const text = await res.text().catch(()=>null);
          throw new Error(text || "Failed to create short link");
        }

        const data = await res.json();

        errorMsg.style.display = "none";
        successContainer.style.display = "block";
        successContainer.innerHTML = `
          <div class="card p-4 mt-3">
            <h5 class="text-success mb-3 text-center">Short Link Created!</h5>
            <p><strong>Shortened URL:</strong>
              <a href="#" onclick="handleRedirect('${data.shortCode}')" class="text-primary">${data.shortenedUrl}</a>
              <button class="copy-btn ms-2" data-copy="${data.shortenedUrl}">Copy</button>
            </p>
            <p><strong>Original URL:</strong> <a href="${data.originalUrl}" target="_blank">${data.originalUrl}</a></p>
            <p><strong>Clicks:</strong> ${data.clickCount ?? 0}</p>
            <p><strong>Expires:</strong> ${data.expirationTime ? new Date(data.expirationTime).toLocaleString() : 'â€”'}</p>
          </div>
        `;

        const copyBtn = successContainer.querySelector(".copy-btn");
        if (copyBtn) {
          copyBtn.addEventListener("click", () => {
            navigator.clipboard.writeText(copyBtn.getAttribute("data-copy"));
          });
        }

        form.reset();
      } catch (err) {
        successContainer.style.display = "none";
        errorMsg.textContent = err.message;
        errorMsg.style.display = "block";
      }
    });
</script>
</body>
</html>
