<!DOCTYPE html>
<html>
<head>
    <title>Public Links</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
          font-family: Arial, sans-serif;
          margin: 40px;
          background-color: #f8f9fa;
        }

        header {
          background-color: #0078D7;
          color: white;
          padding: 15px 0;
          text-align: center;
          margin-bottom: 20px;
        }

        nav a {
          color: white;
          margin: 0 15px;
          text-decoration: none;
          font-weight: 500;
        }

        nav a:hover {
          text-decoration: underline;
        }

        h2 {
          text-align: center;
          margin-bottom: 20px;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
          background-color: white;
        }

        th, td {
          padding: 10px;
          border: 1px solid #ddd;
          text-align: left;
        }

        th {
          background-color: #0078D7;
          color: white;
        }

        a {
          color: #0078D7;
          text-decoration: none;
        }

        a:hover {
          text-decoration: underline;
        }

        .pagination {
          text-align: center;
          margin-top: 20px;
        }

        .pagination button {
          background-color: #0078D7;
          color: white;
          border: none;
          padding: 8px 12px;
          margin: 0 5px;
          border-radius: 5px;
          cursor: pointer;
        }

        .pagination button:hover {
          background-color: #005fa3;
        }

        .pagination button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }
    </style>
</head>
<body>

<header id="mainHeader">
    <h2>URL Shortener</h2>
    <nav>
        <a href="/dashboard.html">Dashboard</a>
        <a href="/create.html">Create Link</a>
        <a href="/public.html">Public Links</a>
        <a href="javascript:void(0);" id="logoutLink">Logout</a>
    </nav>
</header>

<div class="container">
    <h2>All Public Links</h2>

    <table id="publicLinksTable">
        <thead>
        <tr>
            <th>Shortened URL</th>
            <th>Original URL</th>
            <th>Clicks</th>
            <th>Created</th>
            <th>Expires</th>
        </tr>
        </thead>
        <tbody>
        <tr><td colspan="5" class="text-center">Loading...</td></tr>
        </tbody>
    </table>

    <div class="pagination">
        <button id="prevPage">Previous</button>
        <button id="nextPage">Next</button>
    </div>
</div>

<script>
    const API_URL = "/url-shortner/public";
    let currentPage = 0;
    const pageSize = 10;

    async function fetchPublicLinks(page = 0) {
      try {
        const response = await fetch(`${API_URL}?page=${page}&size=${pageSize}`);
        if (!response.ok) throw new Error("Failed to fetch public links");

        const data = await response.json();
        const links = Array.isArray(data) ? data : (data.content || []);
        const tbody = document.querySelector("#publicLinksTable tbody");
        tbody.innerHTML = "";

        if (links.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center">No public links found</td></tr>`;
          return;
        }

        links.forEach(link => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><a href="${link.shortenedUrl}" target="_blank">${link.shortenedUrl}</a></td>
            <td><a href="${link.originalUrl}" target="_blank">${link.originalUrl}</a></td>
            <td>${link.clickCount ?? 0}</td>
            <td>${new Date(link.createdAt).toLocaleString()}</td>
            <td>${link.expirationTime ? new Date(link.expirationTime).toLocaleString() : "-"}</td>
          `;
          tbody.appendChild(tr);
        });

        // Pagination controls
        document.getElementById("prevPage").disabled = page <= 0;
        const totalElements = data.totalElements ?? links.length;
        const totalPages = Math.ceil(totalElements / pageSize);
        document.getElementById("nextPage").disabled = page >= totalPages - 1;

      } catch (err) {
        console.error(err);
        alert(err.message);
      }
    }

    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 0) {
        currentPage--;
        fetchPublicLinks(currentPage);
      }
    });

    document.getElementById("nextPage").addEventListener("click", () => {
      currentPage++;
      fetchPublicLinks(currentPage);
    });

    document.getElementById("logoutLink").addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("accessToken");
      localStorage.removeItem("refreshToken");
      window.location.href = "/login.html";
    });

    fetchPublicLinks();
</script>

</body>
</html>
